# WETH flash swaps

## Description

This bot takes advantage of arbitrage opportunities between Uniswap v2 and v3 pools. The strategy is:

1. **Identify price discrepancy**: Every block, the bot will check the price of WETH in both pools and decide whether to attempt the transaction.
2. **Flash Swap from Token/WETH Pool**: The bot initiates a flash swap by borrowing a token from a Uniswap v3 pool that is paired with WETH.
3. **Swap the Token for WETH**: The borrowed token is immediately swapped back to WETH in a Uniswap v2 pool.
4. **Repay the WETH Loan**: The bot then repays the WETH to the Uniswap v3 pool from which it borrowed.
5. **Profit**: Any remaining WETH after the loan repayment is kept as profit.

## Aim

This bot is not intended to land transactions but to practise:

- **Foundry**
- **Interacting with Uniswap v2 and v3 from smart contracts**
- **Reading from Storage and Calling Contracts**
- **Simulating and Sending Flashbots Bundles**

## Forge tests

Tests are written assuming Mainnet pool addresses so a Mainnet RPC url must be used

```bash
forge build

# RPC_URL=https://mainnet.infura.io/v3/<PROJECT_ID>
forge test -f $RPC_URL -vvv
```

## Setup

### Prerequisites

- **Node.js**: Version 18.17.1
- **npm**: Version 9.6.7

### Installation

1. **Clone the Repository**:

   ```bash
   git clone https://github.com/mathcoder9/UniswapFlashArb.git
   cd UniswapFlashArb
   ```

2. **Install Dependencies**:

   ```bash
   npm install
   ```

## Running on local Mainnet or Sepolia fork

### Mainnet Fork

When the bot is run locally with the Mainnet configuration, it performs arbitrage between the USDC/WETH pairs on Uniswap v2 and v3 pools. To create a price discrepancy that the bot can exploit for arbitrage, the bot will first artificially increase the price of USDC in the Uniswap v2 pool by purchasing USDC.

### Sepolia Fork

For testing on the Sepolia fork, I have set up the following:

1. **ERC20 Token (HGR - Hungry)**:

   - Deployed a custom ERC20 token called HGR (Hungry). [HGR Token Contract](https://sepolia.etherscan.io/token/0xd6af5333dee494ddfb6f72ada7b4ed950be585a6?a=0xb763158b7653816a099fcbd79f28c847bb21e2ac)

2. **WETH9 Contract**:

   - Deployed a WETH9 contract for wrapping and unwrapping ETH. [WETH9 Contract](https://sepolia.etherscan.io/address/0x788eef099ae11ebf763bc82b043301a62441698d)

3. **Uniswap Pools**:
   - Created a [Uniswap v2 Pool](https://sepolia.etherscan.io/address/0xf5280DE209E5162DA118E6d587542B42ab0605C0) and a [Uniswap v3 Pool](https://sepolia.etherscan.io/token/0x459a27D2f46AB5784C5297F0547936a475Fe3fDa) for the HGR/WETH trading pair and added liquidity to both.

This setup allows the bot to (barely - SepoliaEth is hard to come by) perform arbitrage between the HGR and WETH pairs on the Sepolia testnet.

### How to run locally

1. **Run Anvil with Forking**:

   - Start Anvil fork of the desired chain:

   ```bash
   anvil -f <MAINNET_OR_SEPOLIA_RPC_URL> -b 14
   ```

2. **Configure Environment Variables**:

   - Copy `.env.example` to `.env`:

   ```bash
   cp .env.example .env
   ```

   - Set environment variables in `.env` (`.env.example` has a detailed explanation of each environment variable):

     - `DEPLOYER_NETWORK=local`
     - `DEPLOYER_CHAIN_ID`: `1` for Mainnet, `11155111` for Sepolia
     - `EXECUTION_CHAIN_ID`: `1` for Mainnet, `11155111` for Sepolia
     - `LOCAL_EXECUTOR_ADDRESS`: Flash arb contract executor address (generated by Anvil)
     - `LOCAL_EXECUTOR_PRIVATE_KEY`: Flash arb contract executor private key (generated by Anvil)
     - `LOCAL_PRIVATE_KEY`: Flash arb contract deployer private key (generated by Anvil)
     - `LOCAL_RPC_URL`: Set to the location Anvil is listening to (e.g. `http://127.0.0.1:8545`).
     - `LOCAL_PRICE_THRESHOLD`: e.g. 0.995

3. **Deploy the Contract to the Anvil Node**:

   - Run the deployment script:

   ```bash
   forge script contracts/script/FlashArbitrage.s.sol:MyScript --fork-url local --broadcast
   ```

4. **Update `.env` with the Contract address**:

   - Set `LOCAL_FLASHARB_ADDRESS` to the address of the deployed contract.

5. **Run the Bot**:

   - Start the bot:

   ```bash
   npm run local
   ```

# Running on-chain

### Mainnet

Not supported.

The main reason for this is that I haven't integrated searching for opportunities, calculating optimal amounts to borrow, calculating optimal amountToCoinbase etc.

### Sepolia

When running the bot on the Sepolia fork, it will look for arbitrage opportunities in the HGR/WETH pools.

- **Bundling**: A signed Flashbots Bundle containing the arbitrage transaction will be created.
- **Simulation**: The bot will simulate the Flashbots Bundle to ensure the transaction can be executed successfully.

### How to run on-chain (Sepolia)

1. **Configure Environment Variables**:

   - Copy `.env.example` to `.env`:

   ```bash
   cp .env.example .env
   ```

   - Set environment variables in `.env`:

     - `DEPLOYER_NETWORK=live`
     - `DEPLOYER_CHAIN_ID=11155111`
     - `EXECUTION_CHAIN_ID=11155111`
     - `LIVE_FLASHBOTS_RELAY_SIGNING_PRIVATE_KEY`:Flashbot relay signing account private key
     - `LIVE_EXECUTOR_ADDRESS`: Flash arb contract executor address
     - `LIVE_EXECUTOR_PRIVATE_KEY`: Flash arb contract executor private key
     - `LIVE_PRIVATE_KEY`: Flash arb contract deployer private key
     - `LIVE_RPC_URL`: Set a Sepolia RPC url.
     - `LIVE_PRICE_THRESHOLD`: e.g. 0.995

2. **Deploy the Contract to the Sepolia network**:

   - Run the deployment script:

   ```bash
   forge script contracts/script/FlashArbitrage.s.sol:MyScript --fork-url live --broadcast
   ```

3. **Update `.env` with the Contract address**:

   - Set `LIVE_FLASHARB_ADDRESS` to the address of the deployed contract.

4. **Run the Bot**:

   - Start the bot:

   ```bash
   npm run live
   ```
